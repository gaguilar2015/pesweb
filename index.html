<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gian Aguilar">

<title>PES Matching at the SIB</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="pes_short_files/libs/clipboard/clipboard.min.js"></script>
<script src="pes_short_files/libs/quarto-html/quarto.js"></script>
<script src="pes_short_files/libs/quarto-html/popper.min.js"></script>
<script src="pes_short_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pes_short_files/libs/quarto-html/anchor.min.js"></script>
<link href="pes_short_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pes_short_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pes_short_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pes_short_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pes_short_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="pes_short_files/libs/core-js-2.5.3/shim.min.js"></script>
<script src="pes_short_files/libs/react-17.0.0/react.min.js"></script>
<script src="pes_short_files/libs/react-17.0.0/react-dom.min.js"></script>
<script src="pes_short_files/libs/reactwidget-1.0.0/react-tools.js"></script>
<script src="pes_short_files/libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="pes_short_files/libs/reactable-binding-0.2.3.9000/reactable.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#pes-matching-process" id="toc-pes-matching-process" class="nav-link active" data-scroll-target="#pes-matching-process">PES Matching Process</a></li>
  <li><a href="#the-pes-dataset" id="toc-the-pes-dataset" class="nav-link" data-scroll-target="#the-pes-dataset">The PES Dataset</a></li>
  <li><a href="#household-matching---level-1" id="toc-household-matching---level-1" class="nav-link" data-scroll-target="#household-matching---level-1">Household matching - Level 1</a>
  <ul>
  <li><a href="#household-level-matching-guidelines" id="toc-household-level-matching-guidelines" class="nav-link" data-scroll-target="#household-level-matching-guidelines">Household-level matching guidelines</a></li>
  <li><a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing">Preprocessing</a></li>
  <li><a href="#matching-algorithm" id="toc-matching-algorithm" class="nav-link" data-scroll-target="#matching-algorithm">Matching Algorithm</a>
  <ul class="collapse">
  <li><a href="#merging" id="toc-merging" class="nav-link" data-scroll-target="#merging">1. Merging</a></li>
  <li><a href="#scoring-pairs" id="toc-scoring-pairs" class="nav-link" data-scroll-target="#scoring-pairs">2. Scoring pairs</a></li>
  <li><a href="#selecting-matches" id="toc-selecting-matches" class="nav-link" data-scroll-target="#selecting-matches">3. Selecting matches</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul></li>
  <li><a href="#household-matching---level-2" id="toc-household-matching---level-2" class="nav-link" data-scroll-target="#household-matching---level-2">Household Matching - Level 2</a>
  <ul>
  <li><a href="#preprocessing-1" id="toc-preprocessing-1" class="nav-link" data-scroll-target="#preprocessing-1">Preprocessing</a></li>
  <li><a href="#matching-algorithm-1" id="toc-matching-algorithm-1" class="nav-link" data-scroll-target="#matching-algorithm-1">Matching Algorithm</a>
  <ul class="collapse">
  <li><a href="#merging-1" id="toc-merging-1" class="nav-link" data-scroll-target="#merging-1">1. Merging</a></li>
  <li><a href="#scoring-pairs-1" id="toc-scoring-pairs-1" class="nav-link" data-scroll-target="#scoring-pairs-1">2. Scoring pairs</a></li>
  <li><a href="#selecting-matches-1" id="toc-selecting-matches-1" class="nav-link" data-scroll-target="#selecting-matches-1">3. Selecting matches</a></li>
  </ul></li>
  <li><a href="#results-1" id="toc-results-1" class="nav-link" data-scroll-target="#results-1">Results</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PES Matching at the SIB</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gian Aguilar </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="pes-matching-process" class="level2">
<h2 class="anchored" data-anchor-id="pes-matching-process">PES Matching Process</h2>
<p>This document explains the process used to perform household-level and individual-level matching for the 2023 Post-Enumeration Survey, which took place in the months of August-September 2023 as a quality assurance and coverage estimate exercise for the Belize 2022 Population and Housing Census.</p>
<p>To perform the matchings, the general guidelines set out by PES consultant Armando Levinson were followed. However, the implementation for the matching was original. This is one of the first automated systems for PES matching that are known, and the rest of the document will summarize the methods and algorithm.</p>
<p>The original guidelines called for a resource-intensive matching process, in which teams of matchers, reviewers and matching-supervisors are all involved in both household and individual level-matching. Nevertheless, in light of limited resources, the SIB team attempted to abstract, program and automate as much of the process as possible. There were no manual matchers, reviewers, or match supervisors - although there was a manual review and verification mechanism automated through a real-time web dashboard.</p>
<p>The resulting matching program and dashboard were immensely helpful and extremely promising. Although not perfectt (there is certainly always the need for a manual inspection and verification step), the SIB team believes considers the automated matching a success and one that be further improved and refined to become an invaluable tool for PES exercises in the future.</p>
</section>
<section id="the-pes-dataset" class="level2">
<h2 class="anchored" data-anchor-id="the-pes-dataset">The PES Dataset</h2>
<p>The PES dataset had a total of</p>
<ul>
<li><p>92 total enumeration districts, or EDs</p></li>
<li><p>8892 listed households</p></li>
<li><p>6962 households with a result of “Complete” or “Partially Complete”. We’ll call these the <em>respondent</em> PES households.</p></li>
</ul>
<p>The table below shows the total number of complete/partial households within each district and urban/rural area</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-001b015da967c7750fe5" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-001b015da967c7750fe5">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"region":["Belize North","Belize South","Belmopan","Cayo","Orange Walk","Stann Creek","Toledo","Total"],"Rural":[433,538,952,136,99,887,627,3672],"Urban":[783,1579,401,207,81,46,159,3256],"Total":[1216,2117,1353,343,180,933,786,6928]},"columns":[{"accessor":"region","name":"region","type":"character"},{"accessor":"Rural","name":"Rural","type":"numeric"},{"accessor":"Urban","name":"Urban","type":"numeric"},{"accessor":"Total","name":"Total","type":"numeric"}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"594bd5e8e1b6ccf4c08108874471a001"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="household-matching---level-1" class="level2">
<h2 class="anchored" data-anchor-id="household-matching---level-1">Household matching - Level 1</h2>
<p>The first level of household matching was also known as <em>Level-1 Matching</em>, or <em>Direct Matching</em>. <strong>The broad goal in this step was to quickly identify the easy matches</strong>: household-pairs in the same physical location (ED, block, buiding) that appeared to be the same household after comparing the names in the corresponding household listings. This step was important because we want to identify and exclude as much matches as possible in this “easy” step before moving on to more time-consuming, computationally expensive processes and algorithms.</p>
<section id="household-level-matching-guidelines" class="level3">
<h3 class="anchored" data-anchor-id="household-level-matching-guidelines">Household-level matching guidelines</h3>
<p>We first review the household-matching guidelines in the Matching Manual:</p>
<ol type="1">
<li><p>Select an EA and identify both Census and PES household questionnaires.</p></li>
<li><p>Perform two-way matching of households based on the following information:</p>
<ol type="i">
<li><p>Geography: District, ED, Block, and Building numbers match.</p></li>
<li><p>Name of the household head: Name matches, allowingfor minor spelling mistakes that do not change the pronunciation.</p></li>
<li><p>Name of household members: Name of at least 1 other household member matches, allowing for minor spelling mistakes that do not change the pronunciation.</p></li>
</ol></li>
<li><p>The previous steps may be relaxed if no immediate match is found.</p>
<ul>
<li><p>For example, the building number or even block number do not need to match if all other household items (name of head and members match).</p></li>
<li><p>Similarly, the head might vary between PES and Census, so matching must account for this as well.</p></li>
<li><p>If a PES-Census household match cannot be found within a EA, the search can extend to the surrounding EAs or even nationally. 5124</p></li>
</ul></li>
</ol>
</section>
<section id="preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing">Preprocessing</h3>
<p>To ready the datasets for name-based matching, we first do some cleanup and preparation. In order to be able to more accurately compare the listed household members in the PES and Census households, the following preparation was done in each dataset:</p>
<ol type="1">
<li>The columns containing the household member names were rearranged and sorted based on age and sex.</li>
</ol>
<ul>
<li>This sorting would, in most cases, ensure that persons in the household would be in the same order in both the PES and Census household listings.</li>
<li>This would be useful during matching.</li>
<li>In the case of the PES, the names of <em>outmovers</em> were also included in this process.</li>
</ul>
<ol start="2" type="1">
<li><p>A <em>last_name</em> variable was derived for each household to hold the last name of the listed head. This would also be useful during matching.</p></li>
<li><p>An id variable, <em>hh_id</em>, was derived to uniquely identify each household.</p></li>
</ol>
<ul>
<li><strong>Importantly</strong>, this ID was a concatenation of the ED number, building number, dwelling number and household number.</li>
</ul>
<ol start="4" type="1">
<li>The name columns were cleaned up so that invalid values (“Missing”, “NA”, “None”) could be replaced with empty strings (’’).</li>
</ol>
</section>
<section id="matching-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="matching-algorithm">Matching Algorithm</h3>
<p>As previously explained, this first level of matching was a strict, full matching where ALL variables had to match. The following sections provide an expanded description of the full, direct-matching (Level-1) algorithm.</p>
<section id="merging" class="level4">
<h4 class="anchored" data-anchor-id="merging">1. Merging</h4>
<p>Both datasets were merged, or joined, using the unique <em>hh_id</em>. This means that PES records were joined with Census records if they shared the same ED, building, dwelling and household numbers. In other words, records that were in the same exact geographic location were joined.</p>
<p>The table below illustrates a simplified example of the merge.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-ccbbcbaede384301de2e" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ccbbcbaede384301de2e">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"ed":["41-030-00","41-030-00","41-030-00","41-030-00","41-030-00"],"building_num":["40","6","4","10","3"],"Person1.x":["jose sagastume","evelia castellanos","edwardo ico","abisai alas","anthony ico"],"Person2.x":[null,"lurio maldonado","silvia bah",null,"petronia ico"],"Person1.y":["francisco sabastunes","evelia castainos","edward ico","ida perez","antonio ico"],"Person2.y":[null,"esbin garcia","sylyia ba","adelina garcia","petrona ico"]},"columns":[{"accessor":"ed","name":"ed","type":"character"},{"accessor":"building_num","name":"building_num","type":"character"},{"accessor":"Person1.x","name":"Person1.x","type":"character"},{"accessor":"Person2.x","name":"Person2.x","type":"character"},{"accessor":"Person1.y","name":"Person1.y","type":"character"},{"accessor":"Person2.y","name":"Person2.y","type":"character"}],"columnGroups":[{"name":"PES","columns":["Person1.x","Person2.x"]},{"name":"Census","columns":["Person1.y","Person2.y"]}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"67fc97cb6adf4cf41e3acc910fc6ced1"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Some noteworthy comments on the results of the merge:</p>
<ol type="1">
<li><p><strong>Of the 6962 respondent PES households, only 4119 (58.9%) found an exact geographic match in the Census respondent dataset.</strong> This means that for the remaining 41% of PES respondent households, there exists no respondent Census household in the same geographic location.</p></li>
<li><p>Because both datasets share columns with the same name (“Person<em>N</em>”), the merging algorithm assigned the suffix <em>.x</em> to the PES columns and <em>.y</em> to the Census columns, wherever there was a conflict.</p></li>
<li><p>We can already see some characterstics of the data structure, in which records that appear to be for the same households have many spelling inconsistencies in the member names.</p></li>
<li><p>We can also see the existence of records that likely do not belong to the same household (abisai alas).</p></li>
</ol>
<p>This leads us to the next step.</p>
</section>
<section id="scoring-pairs" class="level4">
<h4 class="anchored" data-anchor-id="scoring-pairs">2. Scoring pairs</h4>
<p>As noted in the previous step, simply matching households based on geographic location is not enough. The final decision must be made on the basis of the listed household members. How do we compare the member names in an automated way? We cannot use an exact-match method, as there will always be inconsistencies in spelling, even when the names belong to the same person. Instead, we need a more flexible algorithm.</p>
<p>In the world of string matching/string search, there are many algorithms that are useful for evaluationg the similarity of two pieces of text (otherwise known as <em>strings</em> in the programming world). For the purpose of this exercise, I selected the <strong>Jaro-Winkler</strong> algorithm.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Jaro-Winkler distance algorithm is a measure of the similarity between two strings. It is a variant of the Jaro similarity algorithm, which compares the two strings character by character and takes into account the number of matching characters and the number of transpositions needed to transform one string into the other.</p>
</div>
</div>
<p>Now, we compare the similarity of the names of the household members using the JW algorithm. This was done in the following way:</p>
<ol type="1">
<li>The name of Person1 in the PES dataset was compared with the name of Person1 in the Census dataset, PES Person2 with Census Person2, and so on for the up to 5 household members (add footnote).</li>
</ol>
<ul>
<li>Remember that we have previously sorted names in both datasets by age and gender, which will maximize chances that we are comparing the correct persons regardless of the order of the original PES and Census member listings.</li>
</ul>
<ol start="2" type="1">
<li>A similarity score was obtained and saved for each comparison.</li>
<li>The maximum score for each record was also saved in a separate variable.</li>
</ol>
<ul>
<li>For example, if for a specific record, the <strong>Person2</strong> comparison received the highest score, perhaps a perfect 1 if the name was <em>exactly</em> in both datasets, this score was saved in its own variable.</li>
</ul>
<p>Now, we have a useful set of scores based on the similarity of the member names in the PES and Census households. How do we decide which are successful matches? In other words, how do we know if the two records are for the same household?</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-494cfe74d243cf4a6472" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-494cfe74d243cf4a6472">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"hh_id":["41-030-00-1-1-1","41-030-00-40-1-1","41-030-00-6-1-1","41-030-00-4-1-1","41-030-00-10-1-1","41-030-00-3-1-1"],"Person1.x":["edwin givara","jose sagastume","evelia castellanos","edwardo ico","abisai alas","anthony ico"],"Person1.y":["edwin gvelarai","francisco sabastunes","evelia castainos","edward ico","ida perez","antonio ico"],"score_p1":[0.88,0.67,0.92,0.9,0.42,0.8],"Person2.x":["lidia ico",null,"lurio maldonado","silvia bah",null,"petronia ico"],"Person2.y":["lydia ico",null,"esbin garcia","sylyia ba","adelina garcia","petrona ico"],"score_p2":[0.82,"NA",0.45,0.78,"NA",0.93]},"columns":[{"accessor":"hh_id","name":"hh_id","type":"character"},{"accessor":"Person1.x","name":"Person1.x","type":"character"},{"accessor":"Person1.y","name":"Person1.y","type":"character"},{"accessor":"score_p1","name":"score_p1","type":"numeric","style":{"background":"#FFECAC","fontWeight":"bold"}},{"accessor":"Person2.x","name":"Person2.x","type":"character"},{"accessor":"Person2.y","name":"Person2.y","type":"character"},{"accessor":"score_p2","name":"score_p2","type":"numeric","style":{"background":"#FFECAC","fontWeight":"bold"}}],"columnGroups":[{"name":"Person 1","columns":["Person1.x","Person1.y","score_p1"]},{"name":"Person 2","columns":["Person2.x","Person2.y","score_p2"]}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"b4632c9e680dfabfacc6f9198bc934fd"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="selecting-matches" class="level4">
<h4 class="anchored" data-anchor-id="selecting-matches">3. Selecting matches</h4>
<p>The simplest way of selecting a match (and the one I chose) is to establish a treshold for the similarity scores and selecting those records that pass the treshold.</p>
<p>After some experimenting and visual inspection, I selected a similarity score of 0.7 as the matching treshold. Essentially, this means that <strong>if any of the name comparisons obtained a Jaro-Wrinkler score greater than 0.7, the household pair was determined to be a successful match</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The 0.7 treshold is somewhat lenient, but given that in this Level-1 Matching, we have already proven that the pair of households are in the exact same geographic location, then we should only need moderate proof that the household member names are similar in order to call it a match with reasonable confidence. This, of course, is an arbitrary choice that may be debated and modified.</p>
</div>
</div>
<p>In addition, each record that was selected as a match was assigned a <strong>confidence score</strong>, depending on how exactly the member names matched. The confidence score was somewhat complex, taking into consideration several factors (head last names, number of matching names, etc.), but a simplified version of assinging a score can be seen below:</p>
<ol type="1">
<li>High - (Max JW score &gt; 0.95)</li>
<li>Moderate - (Max JW score &gt; 0.85)</li>
<li>Fair - (Max JW score &gt;= 0.7)</li>
</ol>
<p>The derived confidence score was then useful in manual/visual reviews, as the example below illustrates.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-9ca77b1eb617440e61d1" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9ca77b1eb617440e61d1">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"ed":["41-030-00","32-030-00","32-055-00"],"building_num":["40","30","6"],"pes_p1":["jose sagastume","emmanuel lopez","kareem flower sr"],"census_p1":["francisco sabastunes","emmanuel lopez.","karin flores"],"max_score":[0.83,0.98,0.85],"confidence":["fair","high","moderate"]},"columns":[{"accessor":"ed","name":"ed","type":"character"},{"accessor":"building_num","name":"building_num","type":"character"},{"accessor":"pes_p1","name":"pes_p1","type":"character"},{"accessor":"census_p1","name":"census_p1","type":"character"},{"accessor":"max_score","name":"max_score","type":"numeric"},{"accessor":"confidence","name":"confidence","type":"character","style":[{"background":"#CCCC00"},{"background":"#32CD32"},{"background":"#9ACD32"}]}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"7dbb42af3660efccd97a013e8add7137"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<p>After the matching and selection process, a total of <strong>3223 PES households</strong> were matched to a Census household.</p>
<ul>
<li>This represents <strong>78.2%</strong> of the 4119 PES households for which a geographically-matching Census household existed. (See step #1: Merging).</li>
<li>This represents <strong>46.3%</strong> of the 6962 respondent PES households.</li>
<li>This represents <strong>36.2%</strong> of all 8892 listed PES households.</li>
</ul>
<p>The table below shows the distribution of Level-1 Matches by region and urban/rural</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-f391a1c161bd4e61ead6" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f391a1c161bd4e61ead6">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"region":["belize north","belize south","belmopan","cayo","orange walk","stann creek","toledo","Total"],"rural":[191,230,465,79,69,383,357,1774],"urban":[227,739,231,101,57,19,75,1449],"Total":[418,969,696,180,126,402,432,3223]},"columns":[{"accessor":"region","name":"region","type":"character"},{"accessor":"rural","name":"rural","type":"numeric"},{"accessor":"urban","name":"urban","type":"numeric"},{"accessor":"Total","name":"Total","type":"numeric"}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"f9ce3839953589ce19f1a879d16ef5d2"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="household-matching---level-2" class="level2">
<h2 class="anchored" data-anchor-id="household-matching---level-2">Household Matching - Level 2</h2>
<p>It is worth noting that the Level-1 matching would only find successful household pairs if both Census and PES households were <em>recorded</em> to be in the exact same physical/geographical location. However, variations in canvassing and interviewer error could mean that a match was missed due to enumerator error. For example: although in reality a household X is in the same geographic location for both PES and Census, the enumerator made an error when recording the building or dwelling number.</p>
<p>In Level-2 matching, we will work with all remaining <strong><em>unmatched</em></strong> households within each ED. At this level, every remaining PES household in the ED will be compared against every remaining Census household in the ED.</p>
<p>To find matches, a special record-linkage procedure was used, in conjuction with a machine learning algorithm that was trained using the high-confidence matches from the Level-1 match set.</p>
<section id="preprocessing-1" class="level3">
<h3 class="anchored" data-anchor-id="preprocessing-1">Preprocessing</h3>
<p>The following preparation was done in order to proceed with this second-level of household matching:</p>
<ol type="1">
<li>We go back to our original set of 6962 respondent PES households.</li>
<li>We add a new variable/column to our PES dataset, where we will indicate if this household found a match during Level-1 matching, and we will also add the confidence score column.</li>
<li>We apply step #2 to the Census dataset as well. (add note)</li>
</ol>
<p>What we have now is our two <em>separate</em> PES and Census datasets, but with special columns that indicate if they specific household record has previously found a match during L1-matching.</p>
</section>
<section id="matching-algorithm-1" class="level3">
<h3 class="anchored" data-anchor-id="matching-algorithm-1">Matching Algorithm</h3>
<section id="merging-1" class="level4">
<h4 class="anchored" data-anchor-id="merging-1">1. Merging</h4>
<p>The merging is simpler but more expansive than the Level-1 merging. For Level-2, we simply merge every unmatched PES household in a given ED, with every other unmatched Census household in the ED. This means that we will end up with a dataset with of N X M total rows, where N is the number of unmatched PES households in the ED, and M is the number of unmatched census households in the ED.</p>
<p>Another way of describing the above merge is to say that we are doing a many-to-many merge of the unmatched PES and Census datasets, <em>blocking</em> by ED. The table below illustrates a simplified picture of this type of merge.</p>
<div class="cell">
<div class="cell-output-display">

<div id="htmlwidget-3a9f30f57647607ea462" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3a9f30f57647607ea462">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"ed":["41-030-00","41-030-00","41-030-00","41-030-00","41-030-00","41-030-00","41-030-00","41-030-00","41-030-00","41-030-00"],"hh_id":["41-030-00-1-1-1","41-030-00-1-1-1","41-030-00-1-1-1","41-030-00-1-1-1","41-030-00-1-1-1","41-030-00-10-1-1","41-030-00-10-1-1","41-030-00-10-1-1","41-030-00-10-1-1","41-030-00-10-1-1"],"Person1.x":["edwin givara","edwin givara","edwin givara","edwin givara","edwin givara","abisai alas","abisai alas","abisai alas","abisai alas","abisai alas"],"Person1.y":["edwin gvelarai","ida perez","david hernandez","jerimas polanco","randy cal","edwin gvelarai","ida perez","david hernandez","jerimas polanco","randy cal"]},"columns":[{"accessor":"ed","name":"ed","type":"character"},{"accessor":"hh_id","name":"hh_id","type":"character"},{"accessor":"Person1.x","name":"Person1.x","type":"character"},{"accessor":"Person1.y","name":"Person1.y","type":"character"}],"columnGroups":[{"name":"PES","columns":["Person1.x"]},{"name":"Census","columns":["Person1.y"]}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"highlight":true,"striped":true,"theme":{"color":"#36454F","backgroundColor":"#ffffff","borderWidth":"0px","stripedColor":"#f9f9fb","highlightColor":"#f1f3f4","cellPadding":7,"tableStyle":{"fontSize":15},"headerStyle":{"borderWidth":"1px","padding":"7px","borderTop":"1px solid #595d63","backgroundColor":"#595d63","textTransform":"uppercase","borderColor":"#595d63","color":"#ffffff","transitionDuration":"0.1s","&:hover[aria-sort]":{"backgroundColor":"#4d5056","color":"#ffffff"},"&[aria-sort='ascending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 3px 0 0 #ffffff"},"&[aria-sort='descending']":{"backgroundColor":"#393c40","color":"#ffffff","boxShadow":"inset 0 -3px 0 0 #ffffff"},"fontSize":12,"fontWeight":"bold"},"groupHeaderStyle":{"&:not(:empty)":{"backgroundColor":"#e4e8ed","textTransform":"uppercase","fontWeight":"bold","color":"#36454F","fontSize":12,"boxShadow":"inset 3px 0 0 0 #ffffff"}},"rowSelectedStyle":{"backgroundColor":"#e4e8ed"},"inputStyle":{"backgroundColor":"#ffffff","color":"#878e94"},"searchInputStyle":{"fontSize":"14px","textTransform":"uppercase","backgroundColor":"#ffffff","color":"#878e94","&:focus":{"color":"#878e94"}},"selectStyle":{"backgroundColor":"#073c57","color":"#ffffff","borderColor":"#ffffff","outlineColor":"#ffffff"},"paginationStyle":{"textTransform":"uppercase","fontSize":"15px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"15px","backgroundColor":"#ffffff","color":"#164861","&:hover":{"backgroundColor":"#052c3f","color":"#ffffff"}},"pageButtonHoverStyle":{"backgroundColor":"#052c3f","color":"#ffffff"},"pageButtonActiveStyle":{"backgroundColor":"#073c57","color":"#ffffff"},"pageButtonCurrentStyle":{"backgroundColor":"#073c57","color":"#ffffff"}},"dataKey":"9e1e73ea64b3dcf43233e8bc709dc9d1"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="scoring-pairs-1" class="level4">
<h4 class="anchored" data-anchor-id="scoring-pairs-1">2. Scoring pairs</h4>
<p>The scoring of the PES-Census pairs was very similar to the the Level-1 scoring. The names of the first five household members were compared in each PES-Census pair, and a similarity score was obtained using the Jaro-Winkler method.</p>
<p>Each of these scores was saved in its own variable/column.</p>
</section>
<section id="selecting-matches-1" class="level4">
<h4 class="anchored" data-anchor-id="selecting-matches-1">3. Selecting matches</h4>
<p>In Level-1 matching, before we even looked at the member names, we already knew that we were comparing households in the same exact physical/geographic location. Any discovered similarity between member names could immediately determine the pair of households to be a true match.</p>
<p>Now, we have more than just 1 pair of PES-Census households per geographic point. We have M pairs of households for every PES household, where M is the number of unmatched Census households in a given ED. How do we select THE true matching pair among these M pairs?</p>
<p>Intuitively, we could simply say that we simply select the pair with the highest sum total of JW similarity scores. Easy, right? Well, there are a few problems with this approach.</p>
<ol type="1">
<li>This method would ALWAYS find a match for each PES household, even if there exists no true match in the Census dataset.</li>
<li>The score sum total is not a good metric to start with, because the sum is cumulative and is influenced by the number of persons being compared.
<ul>
<li>A pair of two-person-PES-household/10-person-Census-household will likely have a high sum of scores than the “true” two-person-PES/two-person-Census pair.</li>
</ul></li>
</ol>
<p>Problem #1 can be partially solved by establishing some sort of minimum threshold to qualify a match, but again this does not solve problem #2. So to avoid getting into developing a complex algorithm to tackle these issues, we might rather decide to use a proven machine-learning algorithm.</p>
<p>For Level-2 matching, I selected a <strong>Random Forest machine-learning algorithm</strong> for selecting matches. I will not get into the details of model, selection and evaluation, but I will mention that a logistic regression model was also evaluated but proved to be less accurate than the random forest model.</p>
<p>A simplified summary of the procedure:</p>
<ol type="1">
<li><p>The random forest model was built using the following formula: <code>y = score_p1 + score_p2 + score_p3 + score_p4 + score_p5</code> where y is the match status (Match/NonMatch) and score_p<em>n</em> are the JW scores obtained during scoring.</p></li>
<li><p>The model was trained using the high-confidence matches from Level-1.</p>
<ul>
<li>Side-note: this is why we appended the ‘match’ and ‘confidence’ columns to our PES and Census datasets during the Merging step.</li>
</ul></li>
<li><p>Whenever the model predicted Y to be a “Match”, this household pair was selected as a true match.</p></li>
</ol>
</section>
</section>
<section id="results-1" class="level3">
<h3 class="anchored" data-anchor-id="results-1">Results</h3>
<p>Hehe</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>